var osmAuth=(function(){var I=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var x=function(t,e){for(var s in e)I(t,s,{get:e[s],enumerable:!0})},E=function(t,e,s,d){if(e&&typeof e=="object"||typeof e=="function")for(var i=k(e),h=0,p=i.length,f;h<p;h++)f=i[h],!M.call(t,f)&&f!==s&&I(t,f,{get:function(n){return e[n]}.bind(null,f),enumerable:!(d=T(e,f))||d.enumerable});return t};var W=function(t){return E(I({},"__esModule",{value:!0}),t)};var H={};x(H,{osmAuth:function(){return q}});function q(t){var e={},s=null;try{s=window.localStorage}catch(n){var d=new Map;s={isMocked:!0,hasItem:function(r){return d.has(r)},getItem:function(r){return d.get(r)},setItem:function(r,o){return d.set(r,o)},removeItem:function(r){return d.delete(r)},clear:function(){return d.clear()}}}function i(n,r){var o=t.url+n;if(arguments.length===1){var u=s.getItem(o)||"";return u.replace(/"/g,"")}else if(arguments.length===2)return r?s.setItem(o,r):s.removeItem(o)}e.authenticated=function(){return!!i("oauth2_access_token")},e.logout=function(){return i("oauth2_access_token",""),i("oauth_token",""),i("oauth_token_secret",""),i("oauth_request_token_secret",""),e},e.authenticate=function(n,r){if(e.authenticated()){n(null,e);return}e.logout(),h(function(o,u){o?n(o):S(function(a){p(a,r,u,n)})})},e.authenticateAsync=function(n){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise(function(r,o){var u=function(a,l){a?o(a):r(l)};h(function(a,l){a?u(a):S(function(c){return p(c,n,l,u)})})}))};function h(n){if(t.singlepage){n(null,void 0);return}var r=550,o=610,u=[["width",r],["height",o],["left",window.screen.width/2-r/2],["top",window.screen.height/2-o/2]].map(function(c){return c.join("=")}).join(","),a=window.open("about:blank","oauth_window",u);if(a)n(null,a);else{var l=new Error("Popup was blocked");l.status="popup-blocked",n(l)}}function p(n,r,o,u){var a=z(),l="/oauth2/authorize?"+U({client_id:t.client_id,redirect_uri:t.redirect_uri,response_type:"code",scope:t.scope,state:a,code_challenge:n.code_challenge,code_challenge_method:n.code_challenge_method,locale:t.locale||""}),c=r!=null&&r.switchUser?"".concat(t.url,"/logout?referer=").concat(encodeURIComponent("/login?referer=".concat(encodeURIComponent(l)))):t.url+l;if(t.singlepage){if(s.isMocked){var w=new Error("localStorage unavailable, but required in singlepage mode");w.status="pkce-localstorage-unavailable",u(w);return}var g=A(window.location.search.slice(1));g.code?e.bootstrapToken(g.code,u):(i("oauth2_state",a),i("oauth2_pkce_code_verifier",n.code_verifier),window.location=c)}else{var v=setInterval(function(){if(o.closed){var _=new Error("Popup was closed prematurely");_.status="popup-closed",u(_),window.clearInterval(v),delete window.authComplete}},1e3);e.popupWindow=o,o.location=c}window.authComplete=function(_){clearTimeout(v);var m=A(_.split("?")[1]);if(m.state!==a){var y=new Error("Invalid state");y.status="invalid-state",u(y);return}f(m.code,n.code_verifier,R),delete window.authComplete};function R(_,m){if(t.done(),_){u(_);return}var y=JSON.parse(m.response);i("oauth2_access_token",y.access_token),u(null,e)}}function f(n,r,o){var u=t.url+"/oauth2/token?"+U({client_id:t.client_id,redirect_uri:t.redirect_uri,grant_type:"authorization_code",code:n,code_verifier:r});e.rawxhr("POST",u,null,null,null,o),t.loading()}return e.bringPopupWindowToFront=function(){var n=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),n=!0)}catch(r){}return n},e.bootstrapToken=function(n,r){var o=i("oauth2_state");i("oauth2_state","");var u=A(window.location.search.slice(1));if(u.state!==o){var a=new Error("Invalid state");a.status="invalid-state",r(a);return}var l=i("oauth2_pkce_code_verifier");i("oauth2_pkce_code_verifier",""),f(n,l,c);function c(w,g){if(t.done(),w){r(w);return}var v=JSON.parse(g.response);i("oauth2_access_token",v.access_token),r(null,e)}},e.fetch=function(n,r){if(e.authenticated())return o();return t.auto?e.authenticateAsync().then(o):Promise.reject(new Error("not authenticated"));function o(){return r=r||{},r.headers||(r.headers={"Content-Type":"application/x-www-form-urlencoded"}),r.headers.Authorization="Bearer "+i("oauth2_access_token"),fetch(n,r)}},e.xhr=function(n,r){if(e.authenticated())return o();if(t.auto){e.authenticate(o);return}else{r("not authenticated",null);return}function o(){var a=n.prefix!==!1?t.apiUrl+n.path:n.path;return e.rawxhr(n.method,a,i("oauth2_access_token"),n.content,n.headers,u)}function u(a,l){a?r(a):l.responseXML?r(a,l.responseXML):r(a,l.response)}},e.rawxhr=function(n,r,o,u,a,l){a=a||{"Content-Type":"application/x-www-form-urlencoded"},o&&(a.Authorization="Bearer "+o);var c=new XMLHttpRequest;c.onreadystatechange=function(){c.readyState===4&&c.status!==0&&(/^20\d$/.test(c.status)?l(null,c):l(c,null))},c.onerror=function(g){l(g,null)},c.open(n,r,!0);for(var w in a)c.setRequestHeader(w,a[w]);return c.send(u),c},e.preauth=function(n){return n&&n.access_token&&i("oauth2_access_token",n.access_token),e},e.options=function(n){return arguments.length?(t=n,t.apiUrl=t.apiUrl||"https://api.openstreetmap.org",t.url=t.url||"https://www.openstreetmap.org",t.auto=t.auto||!1,t.singlepage=t.singlepage||!1,t.loading=t.loading||function(){},t.done=t.done||function(){},e.preauth(t)):t},e.options(t),e}function U(t){return Object.keys(t).filter(function(e){return t[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}function A(t){for(var e=0;e<t.length&&(t[e]==="?"||t[e]==="#");)e++;return t=t.slice(e),t.split("&").reduce(function(s,d){var i=d.split("=");return i.length===2&&(s[i[0]]=decodeURIComponent(i[1])),s},{})}function P(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function S(t){var e;if(P()){var s=window.crypto.getRandomValues(new Uint8Array(32));e=C(s.buffer);var d=Uint8Array.from(Array.from(e).map(function(p){return p.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",d).then(function(p){var f=C(p);t({code_challenge:f,code_verifier:e,code_challenge_method:"S256"})})}else{var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var h=0;h<64;h++)e+=i[Math.floor(Math.random()*i.length)];t({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function z(){var t;if(P()){var e=window.crypto.getRandomValues(new Uint8Array(32));t=C(e.buffer)}else{var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";t="";for(var d=0;d<64;d++)t+=s[Math.floor(Math.random()*s.length)]}return t}function C(t){return btoa(String.fromCharCode.apply(null,new Uint8Array(t))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}return W(H);})();
//# sourceMappingURL=osm-auth.iife.js.map
